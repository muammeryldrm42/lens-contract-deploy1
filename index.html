<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Lens Testnet — Deployer</title>
  <style>
    body { font-family: sans-serif; background:#0b0f14; color:#eee; margin:0; padding:20px; }
    h1 { font-size:20px; }
    .card { background:#121923; padding:15px; border-radius:12px; margin-bottom:15px; }
    label { display:block; margin-top:8px; font-size:14px; }
    input { width:100%; padding:8px; border-radius:8px; border:1px solid #333; background:#0e141b; color:#eee; }
    button { margin-top:10px; padding:10px 15px; border:none; border-radius:8px; background:#1f6feb; color:#fff; font-weight:bold; cursor:pointer; }
    pre { background:#0e141b; padding:10px; border-radius:8px; max-height:200px; overflow:auto; font-size:12px; }
  </style>
  <script src="https://unpkg.com/ethers@6.13.1/dist/ethers.umd.min.js"></script>
  <!-- compiler dosyası gerekli: solc.min.js veya soljson.js + wrapper.js -->
  <script src="./solc.min.js"></script>
</head>
<body>
  <h1>Lens Testnet — Contract Deployer</h1>
  <button onclick="connectWallet()">Connect Wallet</button>
  <button onclick="switchToLens()">Switch to Lens Testnet</button>

  <div class="card">
    <h2>Deploy ERC-20</h2>
    <label>Name <input id="erc20-name" value="MyToken"></label>
    <label>Symbol <input id="erc20-symbol" value="MTK"></label>
    <label>Initial Supply <input id="erc20-supply" value="1000000"></label>
    <button onclick="deployERC20()">Deploy ERC20</button>
  </div>

  <div class="card">
    <h2>Deploy ERC-721</h2>
    <label>Name <input id="erc721-name" value="MyNFT"></label>
    <label>Symbol <input id="erc721-symbol" value="MNFT"></label>
    <button onclick="deployERC721()">Deploy ERC721</button>
  </div>

  <div class="card">
    <h2>Status</h2>
    <pre id="status">Ready.</pre>
  </div>

<script>
const statusEl = document.getElementById('status');
function log(msg){ statusEl.textContent += "\n" + msg; }
function set(msg){ statusEl.textContent = msg; }

const LENS_CHAIN_ID_HEX = '0x90f7'; // 37111
const LENS_PARAMS = {
  chainId: LENS_CHAIN_ID_HEX,
  chainName: 'Lens Chain Testnet',
  nativeCurrency: { name: 'GRASS', symbol: 'GRASS', decimals: 18 },
  rpcUrls: ['https://rpc.testnet.lens.xyz'],
  blockExplorerUrls: ['https://explorer.testnet.lens.xyz']
};

let provider, signer;

async function connectWallet(){
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  set("Wallet connected: " + await signer.getAddress());
}

async function switchToLens(){
  try{
    await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: LENS_CHAIN_ID_HEX }] });
  }catch(e){
    if(e.code===4902){
      await window.ethereum.request({ method:'wallet_addEthereumChain', params:[LENS_PARAMS] });
    }
  }
}

function compile(srcName, srcCode){
  if(typeof window.solc==='undefined') throw new Error("solc not loaded");
  const input = { language:'Solidity', sources:{[srcName]:{content:srcCode}}, settings:{ outputSelection:{ '*':{'*':['abi','evm.bytecode.object']}}}};
  const output = JSON.parse(solc.compile(JSON.stringify(input)));
  const contractName = Object.keys(output.contracts[srcName])[0];
  const artifact = output.contracts[srcName][contractName];
  return { abi: artifact.abi, bytecode: "0x"+artifact.evm.bytecode.object };
}

async function deployERC20(){
  try{
    set("Compiling ERC20...");
    const src = `// SPDX-License-Identifier: MIT
    pragma solidity ^0.8.20;
    contract MintableToken {
      string public name; string public symbol; uint8 public decimals=18; uint256 public totalSupply;
      address public owner; mapping(address=>uint256) public balanceOf;
      event Transfer(address indexed from,address indexed to,uint256 value);
      modifier onlyOwner(){require(msg.sender==owner);_; }
      constructor(string memory _n,string memory _s,uint256 _supply){name=_n;symbol=_s;owner=msg.sender;
        uint256 supply=_supply*10**decimals; totalSupply=supply; balanceOf[msg.sender]=supply;
        emit Transfer(address(0),msg.sender,supply);}
      function mint(address to,uint256 amount) external onlyOwner {uint256 v=amount*10**decimals;totalSupply+=v;balanceOf[to]+=v;emit Transfer(address(0),to,v);}
    }`;
    const {abi,bytecode} = compile("MintableToken.sol", src);
    const factory = new ethers.ContractFactory(abi, bytecode, signer);
    const c = await factory.deploy(
      document.getElementById('erc20-name').value,
      document.getElementById('erc20-symbol').value,
      BigInt(document.getElementById('erc20-supply').value)
    );
    log("Deploying ERC20 tx: "+c.deploymentTransaction().hash);
    await c.waitForDeployment();
    log("Deployed ERC20 at: "+await c.getAddress());
  }catch(err){ log("Error: "+err.message); }
}

async function deployERC721(){
  try{
    set("Compiling ERC721...");
    const src = `// SPDX-License-Identifier: MIT
    pragma solidity ^0.8.20;
    contract SimpleNFT {
      string public name; string public symbol; uint256 public nextTokenId; address public owner;
      mapping(uint256=>address) public ownerOf; event Transfer(address from,address to,uint256 id);
      modifier onlyOwner(){require(msg.sender==owner);_; }
      constructor(string memory _n,string memory _s){name=_n;symbol=_s;owner=msg.sender;}
      function mint(address to) external onlyOwner returns(uint256){uint256 id=++nextTokenId; ownerOf[id]=to; emit Transfer(address(0),to,id); return id;}
    }`;
    const {abi,bytecode} = compile("SimpleNFT.sol", src);
    const factory = new ethers.ContractFactory(abi, bytecode, signer);
    const c = await factory.deploy(
      document.getElementById('erc721-name').value,
      document.getElementById('erc721-symbol').value
    );
    log("Deploying ERC721 tx: "+c.deploymentTransaction().hash);
    await c.waitForDeployment();
    log("Deployed ERC721 at: "+await c.getAddress());
  }catch(err){ log("Error: "+err.message); }
}
</script>
</body>
</html>
